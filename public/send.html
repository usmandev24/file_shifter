<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/public/styles/main_styles.css" />
    <title>Send To Device</title>
  </head>

  <body>
    <div
      class="flex flex-1 justify-between items-center border-b border-base-300 m-auto"
    >
      <div class="w-[2rem]"></div>
      <h1 class="text-xl lg:text-2xl p-2 ml-2 font-bold">
        <a href="/">Data Shifter</a>
      </h1>

      <div class="dropdown dropdown-end dropdown-bottom">
        <div
          role="button"
          tabindex="0"
          class="btn text-xl w-8 h-12 mr-4 rotate-90"
        >
          |||
        </div>
        <ul
          class="dropdown-content bg-base-100 border border-gray-500 rounded-lg menu menu-vertical w-32 z-10 p-2 m-2 mr-3"
        >
          <li class=""><a class="btn mb-1" href="/send">Send</a></li>
          <li class=""><a class="btn mb-1" href="/receive">Recieve</a></li>
          <li class=""><a class="link link-info m-auto" href="">About</a></li>
        </ul>
      </div>
    </div>
    <div
      class="flex flex-1 flex-col h-100 m-2 md:m-12 lg:m-16 items-center justify-center-safe"
    >
      <div class="card card-md md:card:md lg:card-lg xl:card-xl bg-base-300 ">
        <div class="card-body items-center p-4 md:p-8">
          <h2 class="card-title text-xl mt-3">
            Send To Other Device (PC/Mobile)
          </h2>
          <p class="mt-3">
            Make sure your both devices conected to same WIFI network or One
            device connected with hotspot of other device. Like your PC
            connected with your Mobile Hotspot .
          </p>
          <div class="card-actions mt-3">
            <input
              type="file"
              multiple
              id="file-input"
              class="input file-input file-input-primary active:file-input-success"
            />
          </div>
          <div class="w-full" id="show-files"></div>
          <div
            style="display: none"
            class="break-words btn-primary m-auto flex-col align-middle
             text-secondary, text-primary, text-info, progress-info, progress-error, progress-secondary, alert-error"
          ></div>
        </div>
      </div>
    </div>
    <script>
      const file_input = document.getElementById("file-input");
      const show_files = document.getElementById("show-files");
      file_input.onchange = show;

      function show() {
        let allSendFunctions = [];
        let allsdBtns = [];
        Array.from(file_input.files).map((file, index) => {
          console.log(file);
          const oneFileSet = document.createElement("div");
          oneFileSet.className =
            "flex flex-col gap-1  w-full p-2 mt-3 border border-base-100 rounded-lg bg-base-200";
          const nameRow = document.createElement("div");
          nameRow.className =
            "flex justify-between break-all items-center rounded-lg p-1 pr-2";

          const name = document.createElement("h3");
          let fileSize = (file.size / (1024 * 1024)).toFixed(2) + "MB";
          if (file.size / (1024 * 1024) < 1)
            fileSize = (file.size / 1024).toFixed(2) + "KB";
          name.textContent = `${file.name} (${fileSize})`;

          const sdBtn = document.createElement("button");
          sdBtn.className = "btn btn-sm md:btn-md  btn-outline text-primary";
          sdBtn.textContent = "Send";

          const pRow = document.createElement("div");
          pRow.className = "flex flex-row justify-center items-center";

          const pbar = document.createElement("progress");
          pbar.max = 100;
          pbar.value = 30;
          pbar.className = " progress progress-info  h-3 md:h-4  mr-4";

          const percent = document.createElement("p");
          percent.className = " p-1 md:p-2 ";
          percent.textContent = "50%";

          const speed = document.createElement("p");
          speed.className = "p-1 md:p-2";
          speed.textContent = "10.00MB/s";

          pRow.appendChild(pbar);
          pRow.appendChild(percent);
          pRow.appendChild(speed);

          nameRow.appendChild(name);
          nameRow.appendChild(sdBtn);
          oneFileSet.appendChild(nameRow);

          const infoAltert = el("div", {
            className: "alert alert-info alert-soft alert-horizontal",
            textContent: "Uploading file to Server",
          });
          let cancleBtnCliked = false;
          const cancleBtn = el(
            "button",
            {
              className: "btn btn-dash btn-sm md:btn-md text-error",
              onclick: () => {
                cancleBtnCliked = true;
                sdBtn.click();
              },
            },
            "Cancle"
          );

          const infoRow = el(
            "div",
            {
              className: "flex  flex-row justify-center gap-4 items-center",
            },
            infoAltert,
            el("div", {}, cancleBtn)
          );
          const pbarInfoDiv = el(
            "div",
            {
              className:
                " flex-col  justify-start align-start transition-all  ease-in-out duration-[500ms] scale-y-100",
            },
            pRow,
            infoRow
          );
          pbarInfoDiv.style.display = 'none'
          let pbarInfoDivheight ;
          oneFileSet.appendChild(pbarInfoDiv);
          show_files.appendChild(oneFileSet);
          name.onclick = () => {
            console.log(pbarInfoDiv.style.height, pbarInfoDivheight)
            if (pbarInfoDiv.style.height === "0px") {
              pbarInfoDiv.classList.replace("scale-y-0", "scale-y-100");
              pbarInfoDiv.style.height = pbarInfoDivheight;
            } else {
              pbarInfoDiv.classList.replace("scale-y-100", "scale-y-0");
              pbarInfoDiv.style.height = "0px";
            }
          };
          sdBtn.onclick = onEachSdBtn;
          let xhr;
          let Paused = false;
          let cancled = false;
          async function onEachSdBtn() {
            let chnkSize = 20 * 1024 * 1024;
            if (file.size < 100 * 1024 * 1024) chnkSize = 5 * 1024 * 1024;
            const totalChnk = Math.ceil(file.size / chnkSize);
            console.log(totalChnk);
            //Show pbar , info'
            pbarInfoDiv.style.display = "flex"
            pbarInfoDiv.style.height = pbarInfoDiv.getBoundingClientRect().height+'px';
            pbarInfoDivheight = pbarInfoDiv.getBoundingClientRect().height+'px';
            console.log(pbarInfoDivheight)
            if (
              (sdBtn.textContent === "Send" && !cancleBtnCliked) ||
              (sdBtn.textContent === "Resume" && !cancleBtnCliked)
            ) {
              let index = 0;
              xhr = new XMLHttpRequest();
              if (sdBtn.textContent === "Resume") Paused = false;
              for (; index < totalChnk; ) {
                if (cancled || Paused) {
                  break;
                }
                Paused = false;

                let lastPart = false;
                console.log(index);
                const filePart = file.slice(
                  index * chnkSize,
                  (index + 1) * chnkSize
                );
                if (index + 1 === totalChnk) lastPart = true;
                let resevedIndex = await sendFile(
                  file,
                  filePart,
                  xhr,
                  oneFileSet,
                  sdBtn,
                  pRow,
                  pbar,
                  percent,
                  speed,
                  infoAltert,
                  cancleBtn,
                  pbarInfoDiv,
                  chnkSize,
                  totalChnk,
                  index,
                  lastPart
                );

                index = resevedIndex;
              }
            } else if (cancleBtnCliked) {
              cancleBtn.disabled = true;
              sdBtn.textContent = "Canceled";
              sdBtn.classList.remove("text-primary", "text-info");
              sdBtn.classList.add("text-warning");

              cancled = true;
              setTimeout(() => {
                pbarInfoDiv.classList.replace("scale-y-100", "scale-y-0");
                pbarInfoDiv.style.height = 0;
                console.log(pbarInfoDivheight);
              }, 1000);
              sdBtn.disabled = true;
              allsdBtns.filter((v, i) => {
                if (i != index) return v;
              });
              allSendFunctions.filter((v, i) => {
                if (i != index) return v;
              });
              await cancelSending(xhr);
              console.log("canceled");
            } else if (sdBtn.textContent === "Pause") {
              Paused = true;
              sdBtn.textContent = "Resume";
              sdBtn.classList.replace("text-info", "text-secondary");
              pbar.classList.replace("progress-info", "progress-secondary");
              infoAltert.textContent = "Sending Paused...";
              await cancelSending(xhr);
            }
          }

          allSendFunctions.push(onEachSdBtn);
          allsdBtns.push(sdBtn);

          const totalFiles = Array.from(file_input.files).length;
          if (index + 1 === totalFiles) {
            const sendAllBtnDIV = document.createElement("div");
            sendAllBtnDIV.className = "flex flex-row justify-center mt-4";
            const sendAllbtn = document.createElement("button");
            sendAllbtn.textContent = "Send All Above Files";
            sendAllbtn.className = "btn btn-primary w-max m-auto  ";
            sendAllBtnDIV.appendChild(sendAllbtn);
            show_files.appendChild(sendAllBtnDIV);

            sendAllbtn.onclick = async () => {
              sendAllbtn.disabled = true;
              for (let fun of allSendFunctions) {
                await fun();
              }
              const isSended = allsdBtns.every((btn, index) => {
                if (btn.textContent === "Completed") return true;
              });
              if (isSended) {
                sendAllbtn.textContent =
                  "✅ All Above Files Sended Successfully";
                sendAllbtn.className = "alert alert-success alert-soft";
                sendAllbtn.role = "alert";
              }
            };
          }
        });
      }

      //xhr = xmlHttpReq, pbarEle = progress bar Element, percentEle = percent Elemet

      async function sendFile(
        file,
        filePart,
        xhr,
        fileDiv,
        sendBtn,
        pRowDiv,
        pbarEle,
        percentEle,
        speedEle,
        infoAltert,
        cancleBtn,
        pbarInfoDiv,
        chnkSize,
        totalChnk,
        index,
        isLastChnk
      ) {
        return new Promise((reslove, reject) => {
          xhr.open("POST", "/send-to-server");

          xhr.setRequestHeader("filename", file.name);
          xhr.setRequestHeader("filesize", file.size);
          xhr.setRequestHeader("lastmodified", file.lastModified);
          xhr.setRequestHeader("index", index);
          xhr.setRequestHeader("chnksize", chnkSize);
          xhr.setRequestHeader("islast", isLastChnk);

          pRowDiv.style.display = "flex";
          xhr.onloadstart = () => {
            sendBtn.textContent = "Pause";
            sendBtn.className = sendBtn.className.replace(
              /text-primary|text-secondary/,
              "text-info"
            );
            pbarEle.className = pbarEle.className.replace(
              /progress-primary|progress-secondary/,
              "progress-info"
            );
            infoAltert.textContent = "ℹ️Sending File to PC";
            cancleBtn.disabled = false;
          };

          const startTime = Date.now();
          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              let percent =
                ((index * chnkSize + event.loaded) / file.size) * 100;
              pbarEle.value = percent;
              percentEle.textContent = percent.toFixed(1) + "%";
              let speed =
                event.loaded /
                (1024 * 1024) /
                ((Date.now() - startTime) / 1000);
              speedEle.textContent = speed.toFixed(2) + "MB/s";
            }
          };
          xhr.onerror = () => {
            sendBtn.textContent = "Retry";
            sendBtn.className = sendBtn.className.replace(
              /text-primary|text-secondary|text-info/,
              "text-error"
            );
            pbarEle.className = pbarEle.className.replace(
              /progress-primary|progress-secondary|progress-info/,
              "progress-error"
            );
            infoAltert.textContent = "Error While Sending";
            infoAltert.classList.replace("alert-info", "alert-error");

            reject();
          };
          xhr.onabort = () => {
            reslove(totalChnk);
          };

          xhr.onload = () => {
            if (isLastChnk) {
              sendBtn.className = sendBtn.className.replace(
                /text-primary|text-secondary|text-info/,
                "text-success"
              );
              pbarEle.className = pbarEle.className.replace(
                /progress-primary|progress-secondary|progress-info/,
                "progress-success"
              );
              sendBtn.textContent = xhr.responseText;
              infoAltert.textContent = "✅ Successfully Sended";
              infoAltert.classList.replace("alert-info", "alert-success");
              cancleBtn.className = "hidden";
              sendBtn.disabled = true;
              reslove(xhr.responseText);
              setTimeout(() => {
                pbarInfoDiv.classList.replace("scale-y-100", "scale-y-0");
                pbarInfoDiv.style.height = 0;
              }, 2000);
            } else {
              reslove(Number(xhr.getResponseHeader("index")));
            }
          };
          xhr.send(filePart);
        });
      }
      let xhr = new XMLHttpRequest();
      async function cancelSending(xhr) {
        return new Promise((reslove, reject) => {
          xhr.abort();
          xhr.onabort = () => {
            reslove();
          };
        });
      }
      function el(tag, props = {}, ...children) {
        const e = document.createElement(tag);
        Object.assign(e, props);
        children.forEach((c) => {
          if (typeof c === "string") {
            e.appendChild(document.createTextNode(c));
          } else e.appendChild(c);
        });
        return e;
      }
    </script>
  </body>
</html>
